## EBS(Elastic Block Store) 실습
- 볼륨 생성하고 연결하기
    1. Elastic Block Store 메뉴의 하단 볼륨 메뉴 클릭
    2. 볼륨 생성 버튼 클릭
    3. 볼륨 설정 부분의 크기입력, 가용영역 선택 후 볼륨 생성 버튼 클릭(연결하고자 하는 인스턴스와 동일한 가용영역을 선택해야함)
    4. 생성된 볼륨을 선택 후 작업메뉴-> 볼륨 연결 클릭
    5. 연결할 인스턴스 선택 후 볼륨 연결버튼 클릭
    6. 인스턴스 메뉴 -> 인스턴스 선택 -> 스토리지 탭으로 가면 연결된 볼륨 확인가능

- 스냅샷 생성하기
    1. 스냅샷을 생성하고자 하는 볼륨 선택
    2. 작업 메뉴에서 스냅샷 생성 버튼 클릭
    3. 설명 작성후 생성버튼 클릭
    4. 스냅샷 탭으로 가서 확인해보면 스냅샷이 생성되어있는 모습을 확인 가능.

- 스냅샷 삭제하기
    1. 스냅샷 메뉴에서 삭제할 스냅샷 선택
    2. 작업 - 스냅샷 삭제 클릭
    3. 삭제 버튼 클릭

- 볼륨 분리하고 삭제하기
    1. 삭제할 볼륨 선택
    2. 작업 - 볼륨 분리 클릭
    3. 분리 버튼 클릭
    4. 이후에 볼륨 삭제 가능.

## Load Balancing
: 부하(traffic)를 분산시키는 방법. Load Balancer를 통해 가능. Load Balancing 알고리즘에 따라 요청들을 분산시키고, 각 서버에서 처리함.

- 개념정리(빵을 나눠주는 방법)
선생님 1명, 유통기한 30분 남은 빵 1개가 있다.
학생 8 명에게 나눠주고 먹어야한다.
이를 골고루 나눠주는 방법은?

1. 우등생 4명에게만 나눠주기
: 형평성에 어긋남. 남은 4명의 학생은 허기짐, 불평제기

2. 8명에게 8등분해서 나눠주기
: 쟤들은 공부도 못하는데 왜주냐고 우등생 4명이 불만을 제기함.

3. 우등생에게 빵의 4분의 3, 열등생에게 4분의 1을 나눠줌
: 형평성에 어긋남.

4. 빵 잘먹는애 4분의 3, 못 먹는애 4분의 1을 나눠줌
: 억지로 먹는 애가 생김

5. 먹고싶은 사람에게만 빵을 등분해줌
: 형평성도 ok, 효율도 ok

이처럼 선생님이 정한 방법에 따라 나눠주고 각 학생들이 30분내에 먹어서 없앰

선생 : Load Balancer(ELB)
빵: 클라이언트들의 요청
학생 : 각각의 서버(EC2 인스턴스)

- 목적
    1. 성능 향상(Performance)
    2. 안정성 향상(Stablity)
    3. 서버 장애 예방(Back up Plan)
    4. 고가용성(HA - High Availablity)
    : 서버가 오랜기간 동안 정상적으로 작동이 가능한 성질 => 고장이 잘 나지 않음
    5. 성능 향상 기반 제공

- 용어 설명
    1. Load Balancing 알고리즘
    : 트래픽을 각 서버에 분배하는 방법

    2. Health Check
    : 서버가 살아있는지 확인하는 것. 서버가 중단되었다면 트래픽을 분배하지 않는다.

    3. Connection Draining(등록 취소 지연)
    : 사용자의 요청을 처리중인 서버를 곧바로 삭제하지 못하도록 하는 기능
    if . 트래픽이 줄어서 늘렸던 인스턴스 중 몇개를 삭제하려고 할때, 삭제될 인스턴스에 연결중인 사용자가 있을 수 있기 때문에 지정한 시간만큼 기다린 이후에 인스턴스를 제거함.

    4. Latency
    : Load Balancer 와 서버 사이의 지연시간

## ELB(Elastic Load Balancing)
: ELB는 부하를 대상그룹에 속한 여러개의 EC2에 분산시켜주는 역할을 함. ELB는 리전별로 생성되는 특징을 가짐.

- ELB Load Balancer유형
    1. ALB(Application Load Balancer)
        - 개별 요청 수준에서 작동(L7 switch)
        - HTTPS, HTTP
        - http 헤더를 기준으로 트래픽 분배

    2. NLB(Network Load Balancer)
        - 연결 수준에서 작동(L4 switch)
        - TCP, UDP
        - ip주소와 포트번호를 기준으로 트래픽 분배

    3. CLB(Classic Load Balancer)
        - 위의 두 유형을 합친 구형모델

- 대상 그룹이란?
: 부하를 분산 시킬 가용영역 내의 인스턴스들의 집합

## EC2 WordPress 인스턴스 & Load Balancer 생성 실습
- 인스턴스 생성
    1. 인스턴스 메뉴에 접속
    2. 인스턴스 시작 버튼 클릭
    3. 인스턴스의 이름을 입력
    4. AMI 선택(WordPress Bitnami를 검색해서 최상단의 것을 선택 - WordPress Certified by Bitnami and Automattic을 구독해야함) 
    5. 인스턴스 유형 선택(프리티어에서 사용 가능한 t2.micro 선택)
    6. 키 페어 선택
    7. 네트워크 설정에서 보안그룹은 WordPress에서 제공되는 보안유형이 있으므로 생성을 선택
    8. 스토리지 구성에서 용량 저장장치 종류 선택
    9. 인스턴스 시작 버튼 클릭
    10. 인스턴스 메뉴에서 인스턴스가 정상적으로 생성되었는지 확인, 일정시간 후에 상태검사가 완료됐는지 확인할 것.

- 인스턴스에 접속해보기
    1. IPv4 주소를 주소창에 붙여넣기하고 이동
    2. 샘플페이지를 볼 수 있다.

- ELB(Elastic Load Balancing) Load Balancer 생성하기
    1. EC2 메뉴에서 로드 밸런서 메뉴 클릭
    2. 로드 밸런서 생성 클릭
    3. Application Load Balancer 선택
    4. 로드 밸런서의 이름 입력
    5. 네트워크 매핑에서 부하를 분산시킬 가용영역 선택 - EC2 인스턴스의 가용영역을 확인 후 같은 것을 선택 (! 2개 이상의 가용영역과 서브넷을 선택해야함)
    6. 보안그룹 선택 (실습에서는 WordPress에서 생성된 보안그룹 사용)
    7. 리스너 및 라우팅 - 대상 그룹 생성 클릭
    8. 대상 유형 선택
    9. 대상 그룹 이름 입력 후 다음버튼을 눌러 다음단계로 이동
    10. 인스턴스 선택 후 '아래에 보류 중인 것으로 포함' 버튼 클릭
    11. 대상 그룹 생성 버튼 클릭
    12. 로드 밸런서 생성 창으로 돌아와서 대상 그룹 선택
    13. 로드 밸런서 생성 버튼 클릭
    14. 로드 밸런서가 올바르게 생성되었는지 확인 (활성 상태가 되는것을 기다려야 함), 대상 상태 확인 (Healthy)

- 로드 밸런서의 DNS 주소로 접속해보기
    1. 로드 밸런서의 DNS 주소 복사
    2. 주소 입력창에 붙여넣기 후 이동

? DNS로 접속하는 것과 IPv4 주소로 접속하는 것의 차이
: DNS로 접속하게 되면 로드 밸런서를 통해서 접속하는 것. IPv4 주소로 접속하는 것은 인스턴스에 바로 접속하는 것이다.

- 다른 가용영역에 인스턴스 생성
    1. 기존의 인스턴스 생성 과정과 동일
    2. 네트워크 설정 - 편집 버튼 클릭
    3. 서브넷을 대상 그룹 만들때 등록했던 가용영역의 것을 선택
    4. 인스턴스 생성

- 대상 그룹에 인스턴스 추가
    1. 등록된 대상 선택
    2. 대상 등록 버튼 클릭
    3. 추가된 인스턴스를 선택 후 '아래에 보류 중인 것으로 포함' 버튼 클릭
    4. 보류 중인 대상 등록 버튼 클릭

## Load Balancing 작동 확인
- 첫번째 인스턴스의 IPv4 주소로 접근하여 게시물 작성하기
    1. 첫번째 인스턴스의 IPv4 주소/admin 으로 접근
    2. 인스턴스 -> 작업 -> 시스템 로그 가져오기에서 user계정의 비밀번호 확인
    3. ID : user, PW: 로그에서 가져온 비밀번호로 로그인
    4. post -> add new post
    5. 게시물 작성 후 Publish
    6. view post 버튼 클릭하면 게시물 확인가능
    7. 첫번째 인스턴스의 IPv4 주소로 접근하면 작성된 게시물이 보임

- 로드밸런서 DNS로 접근하여 분산 확인하는법
    1. 로드 밸런서의 DNS를 복사하여 접근
    2. 게시물을 확인해보고 있다면 첫번째 인스턴스로 접근이 된 것.
    3. 재접속 과정을 반복하면서 두번째 인스턴스로 접근이 되면 게시물이 보이지않음
    => 부하 분산이 정상적으로 이루어짐

- 문제점
: 각각의 인스턴스에 데이터가 각자 다르게 들어감

- 해결법
: 구조를 변경해서 데이터 서버를 따로 분리

## Auto Scaling
: 자동으로 크기를 조절하는 기능 => 트래픽에 따라서 자동으로 서버(EC2 인스턴스)의 개수를 조절해주는 기능. Auto Scaling은 ELB와 같이 사용

- 필요성
: 서버의 최대 용량은 정해져있음 -> 서버의 용량이 초과되는 트래픽이 발생하면? -> 서버가 터지겄지 -> 이를 해결하기 위해 서버를 많이 사두면되지~ -> 남는 서버 자원 낭비
-> Auto Scaling이 실제 트래픽과 서버 용량을 유사학 조절하면 안정적이며 효율적인 서버 운영 가능

- 기본구조

클라이언트의 요청 -> ELB -> ASG(Auto Scaling Group) -> AMI : 인스턴스를 만들어 낼 때 중요한 역할
                                               -> CloudWatch : 트래픽과 같은 지표를 모니터링하고 정책에 따라 실행함

- ASG(Auto Scaling Group)
: EC2 인스턴스 들의 집합
설정한 값에 따라 인스턴스를 늘였다 줄었다함
CloudWatch와 연동

- 시작 구성(Launch Configuration)
: Auto Scaling을 할 때 사용하는 EC2 인스턴스의 사전 설정 정보
    - AMI
    - 인스턴스 유형
    - 스토리지(EBS)
    - 보안그룹(Security Group)

- 실습
    - 한개의 인스턴스 생성
    
    - AMI 생성
        1. 인스턴스 선택 후 작업 -> 이미지 및 템플릿 -> 이미지 생성
        2. 이미지 이름 입력 후 이미지 생성
        3. AMI 탭에서 생성된 이미지의 상태가 대기중에서 사용 가능으로 바뀌는 것을 확인

    - Auto Scaling 생성
        1. Auto Scaling 그룹 메뉴 접속
        2. Auto Scaling 그룹 생성 버튼 클릭
        3. Auto Scaling 그룹 이름 입력
        4. 시작 템플릿 생성 버튼 클릭
        5. 시작 템플릿 이름 입력
        6. Application and OS Images (Amazon Machine Image) 에서 '내 AMI' 클릭
        7. t2.micro 인스턴스 유형 선택
        8. 키페어 선택
        9. 보안 그룹 선택 OR 생성
        10. 시작 템플릿 생성 버튼 클릭
        11. Auto Scaling 그룹 생성 창으로 돌아와서 시작 템플릿 선택 후 다음
        12. 가용영역 및 서브넷 두개 선택 (로드 밸런서와 동일하게) 후 다음
        13. 기존 로드 밸런서에 연결 선택 -> 기존 로드 밸런서 대상 그룹 선택
        14. Elastic Load Balancer 상태 확인 켜기 체크 후 다음
        15. 최소 최대 용량 선택
        16. 대상 추적 크기 조정 정책 선택 -> 지표 유형을 평균 CPU 사용률 선택 -> 대상값 입력 -> 확대 정책만 생성하려면 축소 비활성화 체크 후 다음
        17. 알림추가는 선택사항이니 다음
        18. 태그 선택사항이니 다음
        19. 검토 후 생성

- 인스턴스가 자동으로 생성되는 이유
: 우리가 ASG의 최소 용량을 1로 설정했기 때문에 설정한 가용 영역에 따라 한개의 인스턴스가 추가로 자동생성된다.

- Auto Scaling 작동 테스트
    1. 자동으로 생성된 인스턴스의 IPv4 주소 복사(Auto Scaling Group에 속한 인스턴스에 스트레스를 줘야하기 때문)
    2. 터미널에 ssh -i 키 파일 경로 bitnami@복사한 주소 입력해서 접속
    3. sudo apt-get install stress 입력해서 다운로드
    4. stress --cpu 4 입력해서 부하를 주고 기다리기
    5. 5분정도 뒤에 해당 인스턴스의 모니터링 탭에서 CPU 사용률이 치솟는 모습을 확인
    6. Auto Scaling - 활동 탭을 확인해보면 추가된 인스턴스를 확인가능
    7. 인스턴스 탭에서도 추가된 인스턴스를 확인 가능
    8. 위의 과정이 정상적으로 이루어졌다면 Auto Scaling이 정상적으로 이루어진 것이다.

- 게시글 작성 테스트
    1. 세개의 인스턴스 중 아까 글을 작성하지 않은 인스턴스에서 글을 작성해보자
    2. 로드 밸런서의 DNS주소로 접근하면 글이 보이다 안보이다가 함
    3. 위의 과정이 올바르게 되었다면 Auto Scaling에 의해 생긴 인스턴스로 정상적으로 부하 분산이 이루어지고 있음을 확인가능

- 리소스 정리
    1. Auto Scaling Group 삭제
    2. 시작 템플릿 삭제
    3. Load Balancer 삭제
    4. 일정 시간이 지난 후 대상 그룹 삭제
    5. 인스턴스 종료(자동으로 생성된 인스턴스는 Auto Scaling Group을 삭제하면 자동으로 종료됨)
        if. 인스턴스 생성시 자동으로 생성되는 볼륨 이외에 생성한 볼륨이 있다면 수동으로 삭제해야함
    6. AMI 등록 취소
    7. 스냅샷 삭제
    8. 보안 그룹 삭제할

- 문제
: 각각의 인스턴스에서 작업을 수행하게되면 각각의 서버에 저장됨

- 해결법
: 서버를 인스턴스 바깥으로 빼서 통합시키면 된다


